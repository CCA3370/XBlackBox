# XBlackBox 故障排查指南 / Troubleshooting Guide

## 常见错误 / Common Errors

### 1. "Unexpected token '<', "<!DOCTYPE "... is not valid JSON"

#### 问题描述 / Problem Description
这个错误通常发生在 Tauri 应用尝试加载 XDR 文件时，收到 HTML 响应而不是预期的 JSON 数据。

This error typically occurs when the Tauri app tries to load an XDR file but receives an HTML response instead of the expected JSON data.

#### 原因 / Causes
1. 文件路径无效或不存在 / Invalid or non-existent file path
2. 文件权限问题 / File permission issues
3. 文件格式不正确（不是有效的 XDR 文件）/ Invalid file format (not a valid XDR file)
4. 服务器错误（在 Web 模式下）/ Server error (in web mode)

#### 解决方案 / Solutions

**步骤 1: 检查日志文件 / Step 1: Check Log Files**
```
日志位置 / Log Location:
Windows: C:\Users\<username>\.xblackbox\logs\
macOS:   /Users/<username>/.xblackbox/logs/
Linux:   /home/<username>/.xblackbox/logs/
```

在应用中点击日志按钮或在控制台中运行：
Click the log button in the app or run in console:
```javascript
const logPath = await api.getLogPath();
console.log('Log path:', logPath);
```

**步骤 2: 验证文件 / Step 2: Verify File**
- 确认文件扩展名为 `.xdr` / Confirm file extension is `.xdr`
- 检查文件大小 < 500MB / Check file size < 500MB
- 确认文件不为空 / Confirm file is not empty
- 尝试在文本编辑器中打开文件头部，应该看到 "XFDR" / Try opening file header in text editor, should see "XFDR"

**步骤 3: 检查权限 / Step 3: Check Permissions**
```bash
# Linux/macOS
ls -l /path/to/file.xdr
chmod 644 /path/to/file.xdr  # 如果需要 / if needed

# Windows (PowerShell)
Get-Acl C:\path\to\file.xdr
```

**步骤 4: 使用绝对路径 / Step 4: Use Absolute Path**
始终使用完整的绝对路径，不要使用相对路径或带有 `..` 的路径。
Always use full absolute paths, not relative paths or paths with `..`.

### 2. 文件加载失败 / File Load Failure

#### 错误消息 / Error Messages
- "File validation failed: Path traversal detected"
- "File too large: X bytes"
- "Invalid file extension"
- "File not found"

#### 解决方案 / Solutions

| 错误 / Error | 解决方法 / Solution |
|-------------|-------------------|
| Path traversal | 使用完整的绝对路径，避免 `..` / Use full absolute path, avoid `..` |
| File too large | 文件必须 < 500MB / File must be < 500MB |
| Invalid extension | 确保文件扩展名为 `.xdr` / Ensure file extension is `.xdr` |
| File not found | 检查路径拼写和文件是否存在 / Check path spelling and file existence |

### 3. 权限被拒绝 / Permission Denied

#### 症状 / Symptoms
- 日志显示 "Permission denied" / Log shows "Permission denied"
- 文件存在但无法读取 / File exists but cannot be read

#### 解决方案 / Solutions

**Linux/macOS:**
```bash
# 检查文件所有者 / Check file owner
ls -l /path/to/file.xdr

# 修改权限 / Change permissions
chmod 644 /path/to/file.xdr

# 如果在受保护的目录中 / If in protected directory
sudo chown $USER:$USER /path/to/file.xdr
```

**Windows:**
1. 右键点击文件 → 属性 → 安全 / Right-click file → Properties → Security
2. 确保您的用户有读取权限 / Ensure your user has read permissions
3. 如果文件在系统文件夹中，将其移动到用户文档文件夹 / If file is in system folder, move to user documents

### 4. 文件格式错误 / Invalid File Format

#### 错误消息 / Error Message
- "Invalid file format. Expected XFDR"
- "Failed to parse XDR file"

#### 验证文件 / Verify File
```bash
# Linux/macOS
hexdump -C /path/to/file.xdr | head -1
# 应该看到: 00000000  58 46 44 52 ...
# Should see: 00000000  58 46 44 52 ...

# Windows (PowerShell)
Format-Hex -Path C:\path\to\file.xdr -Count 16
# 应该看到 "XFDR" / Should see "XFDR"
```

#### 解决方案 / Solutions
1. 确认文件是由 XBlackBox X-Plane 插件生成的 / Confirm file is generated by XBlackBox X-Plane plugin
2. 尝试重新录制飞行数据 / Try re-recording flight data
3. 检查 X-Plane 插件版本是否匹配 / Check X-Plane plugin version matches

## 调试步骤 / Debugging Steps

### 1. 启用详细日志 / Enable Verbose Logging

日志已自动启用。查看日志文件获取详细信息：
Logging is automatically enabled. Check log files for details:

```javascript
// 在浏览器控制台中 / In browser console
const logPath = await window.xdrApi.getLogPath();
console.log('Detailed logs at:', logPath);
```

### 2. 测试简单文件 / Test Simple File

创建测试场景：
Create test scenario:
1. 开始新的 X-Plane 飞行 / Start new X-Plane flight
2. 录制 30 秒的数据 / Record 30 seconds of data
3. 尝试加载该文件 / Try loading that file
4. 如果成功，问题可能是大文件或损坏的数据 / If successful, issue may be large files or corrupted data

### 3. 检查系统资源 / Check System Resources

```bash
# Linux/macOS - 检查磁盘空间 / Check disk space
df -h ~/.xblackbox

# 检查内存 / Check memory
free -h  # Linux
vm_stat  # macOS

# Windows (PowerShell)
Get-PSDrive C | Select-Object Used,Free
Get-Process -Name "XBlackBox*" | Select-Object WorkingSet
```

### 4. 网络诊断（Web 模式）/ Network Diagnostics (Web Mode)

如果在 Web 模式下运行：
If running in web mode:

```javascript
// 检查 API 连接 / Check API connection
fetch('/api/health')
  .then(r => r.json())
  .then(d => console.log('API Status:', d))
  .catch(e => console.error('API Error:', e));
```

## 获取帮助 / Getting Help

### 报告 Bug / Reporting Bugs

提交 issue 时请包含：
When submitting an issue, include:

1. **日志文件内容** / **Log file contents**
   ```
   最近的错误日志（最后 50 行）
   Recent error logs (last 50 lines)
   ```

2. **系统信息** / **System Information**
   - 操作系统和版本 / OS and version
   - XBlackBox 版本 / XBlackBox version
   - X-Plane 版本 / X-Plane version

3. **重现步骤** / **Reproduction Steps**
   - 详细描述操作步骤 / Detailed operation steps
   - 文件信息（大小、类型）/ File information (size, type)
   - 错误截图 / Error screenshots

4. **错误消息** / **Error Messages**
   ```
   复制完整的错误消息和堆栈跟踪
   Copy full error message and stack trace
   ```

### 示例 Issue 模板 / Example Issue Template

```markdown
**问题描述 / Problem Description**
[描述问题 / Describe the issue]

**重现步骤 / Steps to Reproduce**
1. [步骤 1 / Step 1]
2. [步骤 2 / Step 2]
3. [步骤 3 / Step 3]

**预期行为 / Expected Behavior**
[应该发生什么 / What should happen]

**实际行为 / Actual Behavior**
[实际发生了什么 / What actually happened]

**环境信息 / Environment**
- 操作系统 / OS: [例如 Windows 11]
- XBlackBox 版本 / Version: [例如 v1.0.0]
- 文件大小 / File size: [例如 50MB]

**日志 / Logs**
```
[粘贴相关日志 / Paste relevant logs]
```

**截图 / Screenshots**
[如果适用 / If applicable]
```

## 性能优化 / Performance Optimization

### 大文件处理 / Large File Handling

对于大型 XDR 文件（> 100MB）：
For large XDR files (> 100MB):

1. **降采样** / **Downsample**
   - 应用会自动降采样大数据集 / App automatically downsamples large datasets
   - 查看控制台日志了解降采样率 / Check console for downsampling rate

2. **时间范围选择** / **Time Range Selection**
   - 使用时间范围滑块只显示需要的数据 / Use time range sliders to show only needed data
   - 减少同时显示的参数数量 / Reduce number of simultaneously displayed parameters

3. **系统要求** / **System Requirements**
   - 推荐至少 8GB RAM / Recommend at least 8GB RAM
   - 对于超大文件（> 300MB），推荐 16GB RAM / For very large files (> 300MB), recommend 16GB RAM

## 安全最佳实践 / Security Best Practices

1. ✅ 只从可信源加载 XDR 文件 / Only load XDR files from trusted sources
2. ✅ 定期检查和清理日志文件 / Regularly check and clean log files
3. ✅ 使用最新版本的应用 / Use the latest version of the app
4. ✅ 不要在公共计算机上存储敏感飞行数据 / Don't store sensitive flight data on public computers
5. ✅ 定期备份重要的 XDR 文件 / Regularly backup important XDR files

## 常见问答 / FAQ

**Q: 为什么我看不到日志按钮？**
**Q: Why can't I see the log button?**

A: 日志按钮只在 Tauri 桌面应用中显示，Web 模式下不可用。
A: The log button is only shown in the Tauri desktop app, not available in web mode.

---

**Q: 日志文件会占用多少空间？**
**Q: How much space do log files use?**

A: 日志会自动轮转，只保留最近 30 天的日志。平均每天约 1-5MB。
A: Logs auto-rotate, keeping only the last 30 days. Average ~1-5MB per day.

---

**Q: 可以禁用日志吗？**
**Q: Can I disable logging?**

A: 目前不能禁用，但日志很小且会自动清理。这对调试很重要。
A: Currently no, but logs are small and auto-cleaned. They're important for debugging.

---

**Q: 如何提高大文件的加载速度？**
**Q: How to improve loading speed for large files?**

A: 
1. 使用 SSD 而不是 HDD / Use SSD instead of HDD
2. 关闭其他占用内存的程序 / Close other memory-intensive programs
3. 考虑分割大文件为多个小文件 / Consider splitting large files into smaller ones

## 联系支持 / Contact Support

- GitHub Issues: https://github.com/CCA3370/XBlackBox/issues
- 文档 / Documentation: See SECURITY_LOGGING_GUIDE.md
- 更新日志 / Changelog: See CHANGES_SUMMARY.txt
